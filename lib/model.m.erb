#import "<%=header%>"

NSMutableArray * entities(){
static NSMutableArray * _entities = nil;
    if(!_entities){
        _entities = [[NSMutableArray alloc] init];
    }
    return _entities;
}


<%classes.each do |klass|%>
//////////////////////////////////////////////////////////////////////////////
//// <%= klass.objc_class %>
//////////////////////////////////////////////////////////////////////////////
@implementation <%= klass.objc_class %>

<%klass.properties.each do |property|%>
@synthesize <%= property.name %>;
<%end%>

+ (void)initialize{
<%if klass.resource%>
  [self initializeRouting];
<%end%>
  [self initializeMapping];
  (void)[self initializeCoreData];
}

+ (NSEntityDescription * )initializeCoreData
{
    static NSEntityDescription * entity;
    if(entity){
       return entity;
    }
    entity = [[NSEntityDescription alloc] init];
    entity.name = @"<%=klass.objc_class%>";
    entity.managedObjectClassName = @"<%=klass.objc_class%>";

    // -------------------------------------------
    // Define the properties mappings
    NSMutableArray * properties = [NSMutableArray array];
    <%klass.primitive_properties.each do |property|%>
    {
        // <%= property.name %>
        NSAttributeDescription * attrDesc = [[NSAttributeDescription alloc] init];
        attrDesc.name = @"<%= property.name %>";
        [attrDesc setAttributeType:<%= property.ns_attribute_type %>];
        [attrDesc setOptional:NO];
        [properties addObject:attrDesc];
    }
    <%end%>

    // ----------------------------------------------
    // Define 'has one' relationships
    // ----------------------------------------------
    <%klass.has_one_properties.each do |property|%> 
    { 
      // <%= property.name %>
      NSRelationshipDescription * relDesc = [[NSRelationshipDescription alloc] init];
      [relDesc setDestinationEntity:[<%=property.klass.objc_class%> initializeCoreData]];
      relDesc.minCount = 1;
      relDesc.maxCount = 1;
      relDesc.deleteRule = NSCascadeDeleteRule;
      [properties addObject:relDesc];
    }
    <%end%>

    // ----------------------------------------------
    // Define 'has many' objects relationships
    // ----------------------------------------------
    <%klass.has_many_maps_properties.each do |property|%> 
    { 
      // <%= property.name %>
      NSRelationshipDescription * relDesc = [[NSRelationshipDescription alloc] init];
      // Sequence of core data objects
      [relDesc setDestinationEntity:[<%=property.klass.item_class.objc_class%> initializeCoreData]];
      relDesc.deleteRule = NSCascadeDeleteRule;
      [properties addObject:relDesc];
    }
    <%end%>

    // ----------------------------------------------
    // Define 'has many' primitves relationships
    // ----------------------------------------------
    <%klass.has_many_maps_properties.each do |property|%> 
    { 
      // Sequence of primitives
      // This is really a sequence of primitive
#warning <%= property.name %> is a sequence of primitive
    }
    <%end%>

    [entity setProperties:properties];
    [entities() addObject:entity];
    return entity;
}

+ (void)initializeMapping{
    RKObjectMapping* mapping = [RKObjectMapping mappingForClass:[<%=klass.objc_class%> class]];

    // -------------------------------------------
    // Define 'primitive' properties mappings
    // ----------------------------------------------
    <%klass.primitive_properties.each do |property|%> 
    [mapping mapKeyPath:@"<%=property.name%>" toAttribute:@"<%=property.name%>"];
    <%end%>

    // ----------------------------------------------
    // Define 'has one' relationships
    // ----------------------------------------------
    <%klass.has_one_properties.each do |property|%> 
    { 
        RKObjectMapping * mapper = [[RKObjectManager sharedManager].mappingProvider objectMappingForClass:[<%=property.klass.objc_class%> class]];
        [mapping hasOne:@"<%=property.name%>" withMapping:mapper];
    }
    <%end%>

    // ----------------------------------------------
    // Define 'has many' relationships
    // ----------------------------------------------
    <%klass.has_many_properties.each do |property|%> 
    { 
        RKObjectMapping * mapper = [[RKObjectManager sharedManager].mappingProvider objectMappingForClass:[<%=property.klass.item_class.objc_class%> class]];
        [mapping hasMany:@"<%=property.name%>" withMapping:mapper];
    }
    <%end%>

    // -------------------------------------------
    // Register the mapper for the class
    [[RKObjectManager sharedManager].mappingProvider addObjectMapping:mapping];

    // -------------------------------------------
    // Register the serializer for the class
    [[RKObjectManager sharedManager].mappingProvider setSerializationMapping:[mapping inverseMapping] forClass:[<%=klass.objc_class%> class] ];
}

<%if klass.resource%>
+ (NSString *) resourcePath {
  return @"<%= klass.resource.hash[:resource] %>";
}


+ (Class) classForResource{
  return [ <%=klass.resource.objc_resource_type%> class];
}

+ (bool)isSingleton
{
  return <%=klass.resource.c_permission_for 's'%>;
}

+ (bool)canCreate
{
  return <%=klass.resource.c_permission_for 'c'%>;
}

+ (bool)canRead
{
  return <%=klass.resource.c_permission_for 'r'%>;
}

+ (bool)canUpdate
{
  return <%=klass.resource.c_permission_for 'u'%>;
}

+ (bool)canDelete
{
  return <%=klass.resource.c_permission_for 'd'%>;
}
<%end%>

// <%=klass.objc_class%> convenience builder.
// Note that +id+ field if present is not set by this
// builder and so can be used to construct a *new* object
+ (<%=klass.objc_class%> *)buildWith_<%=klass.objc_properites_arg_list_decl%>
{
  <%=klass.objc_class%> * object = [[<%=klass.objc_class%> alloc] init];
<%klass.properties.reject{|p|p.name=='id'}.each do |property|%>
  object.<%=property.name%> = <%=property.name%>;
<%end%>
return object;
}


// Deep Copy
- (id) copyWithZone : (NSZone * ) zone
{
  <%=klass.objc_class%> * object = [[<%=klass.objc_class%> allocWithZone:zone] init];
  <%klass.properties.each do |property|%>
    object.<%=property.name%> = [self.<%=property.name%> copy];
  <%end%>
  return object;
}

@end

<%end%>
